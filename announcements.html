<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>筑界物语 CONTEGA - 服务器公告</title>
    <link rel="stylesheet" href="styles.css"> <!-- 或 styles-chunjie.css -->
    <link rel="icon" type="image/x-icon" href="images/1.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- 动态流体背景 -->
    <div class="ios-background-mesh"></div>

    <header>
        <nav class="navbar">
            <div class="nav-logo">
                <a href="index.html">
                    <i class="fas fa-cube"></i>
                    <span>CONTEGA</span>
                </a>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item"><a href="index.html" class="nav-link">返回主界</a></li>
            </ul>

            <div class="menu-toggle">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </nav>
    </header>

    <section class="hero rules-hero">
        <div class="container">
            <div class="hero-content">
                <div class="hero-badge">最新动态</div>
                <h1>服务器公告 <span class="en-title">ANNOUNCEMENTS</span></h1>
                <p class="hero-subtitle">筑界物语的实时更新、活动通知与重要维护信息。</p>
                
                <div class="server-status-container">
                    <span class="status-dot pulsing"></span>
                    <span>公告中心 · 实时同步</span>
                </div>
            </div>
        </div>
    </section>

    <!-- 公告列表 -->
    <section class="rules-section">
        <div class="container">
            <div id="announcements-list" class="rules-grid">
                <div class="loading-placeholder glass-card hover-lift">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>正在加载最新公告...</p>
                </div>
            </div>

            <div id="no-announcements" style="display: none;" class="glass-card error-placeholder hover-lift">
                <i class="fas fa-info-circle"></i>
                <p>暂无公告</p>
            </div>
        </div>
    </section>

    <!-- 页脚 -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <p>&copy; 2025 Contega (筑界物语) · 公告由中枢系统实时推送 | Design by Silence_yuan</p>
                <div class="social-links">
                    <a href="https://qm.qq.com/q/LJir0hQS40" class="glass-icon"><i class="fab fa-qq"></i></a>
                    <a href="https://space.bilibili.com/3546611829443402" class="glass-icon"><i class="fab fa-bilibili"></i></a>
                </div>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        // 汉堡菜单
        const menuToggle = document.querySelector('.menu-toggle');
        const navMenu = document.querySelector('.nav-menu');
        menuToggle?.addEventListener('click', () => {
            menuToggle.classList.toggle('active');
            navMenu.classList.toggle('active');
        });

        let allAnnouncements = [];

        async function loadAnnouncements() {
            const listContainer = document.getElementById('announcements-list');
            const noAnnouncements = document.getElementById('no-announcements');
            
            listContainer.innerHTML = `
                <div class="loading-placeholder glass-card hover-lift">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>正在加载最新公告...</p>
                </div>
            `;

            try {
                const response = await fetch('/api/announcements');
                if (!response.ok) throw new Error('网络响应失败');

                allAnnouncements = await response.json();
                allAnnouncements.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                renderAnnouncements(allAnnouncements);

                if (allAnnouncements.length === 0) {
                    noAnnouncements.style.display = 'block';
                } else {
                    noAnnouncements.style.display = 'none';
                }
            } catch (error) {
                console.error('加载失败:', error);
                listContainer.innerHTML = `
                    <div class="glass-card error-placeholder hover-lift">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>加载公告失败，请稍后重试</p>
                    </div>
                `;
                noAnnouncements.style.display = 'none';
            }
        }

        function renderAnnouncements(announcements) {
            const listContainer = document.getElementById('announcements-list');
            
            if (announcements.length === 0) {
                listContainer.innerHTML = '';
                document.getElementById('no-announcements').style.display = 'block';
                return;
            }

            document.getElementById('no-announcements').style.display = 'none';

            listContainer.innerHTML = announcements.map(ann => {
                const date = new Date(ann.created_at).toLocaleDateString('zh-CN', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });

                let priorityClass = 'priority-normal';
                let tagText = '公告';
                let iconClass = 'fa-bell';

                switch (parseInt(ann.priority)) {
                    case 3:
                        priorityClass = 'priority-important';
                        tagText = '重要';
                        iconClass = 'fa-exclamation-circle';
                        break;
                    case 2:
                        priorityClass = 'priority-maintenance';
                        tagText = '维护';
                        iconClass = 'fa-tools';
                        break;
                    case 1:
                        priorityClass = 'priority-update';
                        tagText = '更新';
                        iconClass = 'fa-sync-alt';
                        break;
                    default:
                        priorityClass = 'priority-normal';
                        tagText = '公告';
                        iconClass = 'fa-bell';
                }

                return `
                    <div class="rule-card glass-card hover-lift ${priorityClass}">
                        <div class="rule-icon-bg ${priorityClass}">
                            <i class="fas ${iconClass}"></i>
                        </div>
                        <div class="announcement-header">
                            <span class="announcement-date">${date}</span>
                            <span class="announcement-tag ${priorityClass}">${tagText}</span>
                        </div>
                        <h3>${escapeHTML(ann.title)}</h3>
                        <div class="rule-card-content">
                            ${ann.content.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function escapeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        window.addEventListener('load', loadAnnouncements);
    </script>
</body>
</html>