<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>界域供奉 - Contega 筑界物语</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="images/1.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- 页面专属样式 -->
    <style>
        .sponsors-section {
            padding: 100px 20px 60px;
            min-height: 100vh;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        /* 标题彩蛋样式 */
        .page-header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #fbbf24, #d97706); /* 金色渐变 */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s;
            display: inline-block;
        }
        .page-header h1:active { transform: scale(0.95); }

        .page-header p {
            color: var(--ios-text-secondary);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* 管理员面板 (中枢控制台) */
        .admin-panel {
            background: rgba(255, 255, 255, 0.5);
            border: 2px dashed var(--ios-primary);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            backdrop-filter: blur(10px);
        }
        .admin-panel h3 {
            color: var(--ios-primary);
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        /* 列表容器 */
        .list-container {
            border-radius: 24px;
            overflow: hidden;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            box-shadow: var(--glass-shadow);
        }

        /* 表头 */
        .list-header {
            display: grid;
            grid-template-columns: 60px 1fr 120px;
            padding: 15px 25px;
            background: rgba(13, 148, 136, 0.1); /* 极淡的青色 */
            color: var(--ios-primary);
            font-weight: 700;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--glass-border);
        }

        /* 列表项 */
        .list-item {
            display: grid;
            grid-template-columns: 60px 1fr 120px;
            padding: 20px 25px;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            transition: background 0.2s;
            font-size: 1rem;
        }
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background: rgba(255, 255, 255, 0.4); }

        .item-index { color: var(--ios-text-secondary); font-family: monospace; opacity: 0.7; }
        .item-name { font-weight: 600; color: var(--ios-text-primary); display: flex; align-items: center; gap: 10px; }
        .item-amount { 
            text-align: right; 
            font-weight: 700; 
            color: #d97706; /* 金色金额 */
            font-family: 'SF Mono', monospace;
        }

        /* 管理员视图下的网格调整 */
        body.admin-view .list-header, 
        body.admin-view .list-item { 
            grid-template-columns: 60px 1fr 120px 80px; 
        }

        .delete-btn {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: none;
            padding: 6px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .delete-btn:hover { background: #ef4444; color: white; }

        .logout-section {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--glass-border);
        }
        
        .logout-btn {
            background: transparent;
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 10px 24px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
        }
        .logout-btn:hover { background: #ef4444; color: white; }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .admin-form-grid { grid-template-columns: 1fr; }
            .list-header { display: none; } /* 移动端隐藏表头 */
            .list-item { 
                grid-template-columns: 1fr auto; 
                gap: 5px;
                padding: 15px;
            }
            .item-index { display: none; }
            .item-name { font-size: 1.1rem; }
            .item-amount { font-size: 1.1rem; }
            
            body.admin-view .list-item {
                grid-template-columns: 1fr auto;
                grid-template-areas: "name amount" "action action";
            }
            body.admin-view .item-name { grid-area: name; }
            body.admin-view .item-amount { grid-area: amount; }
            body.admin-view .admin-action { grid-area: action; text-align: right; margin-top: 10px; }
        }
    </style>
</head>
<body>

    <!-- 1. 动态流体背景 -->
    <div class="ios-background-mesh"></div>

    <header>
        <nav class="navbar">
            <div class="nav-logo">
                <a href="index.html">
                    <i class="fas fa-cube"></i>
                    <span>CONTEGA</span>
                </a>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="index.html" class="nav-link">返回主界</a></li>
            </ul>
        </nav>
    </header>

    <main class="sponsors-section">
        <div class="container">
            <div class="page-header">
                <!-- ID 保持不变，用于触发彩蛋 -->
                <h1 id="sponsors-main-title"><i class="fas fa-crown"></i> 界域供奉</h1>
                <p>每一份注入的能量，都是维系 Contega 世界法则的基石。<br>向所有维度缔造者致以崇高敬意。</p>
            </div>
           
            <!-- 管理员面板 -->
            <div id="adminPanel" class="admin-panel" style="display: none;">
                <h3><i class="fas fa-terminal"></i> 中枢控制台</h3>
                <form id="addSponsorForm" class="admin-form-grid">
                    <div class="form-group">
                        <label for="sponsorName">缔造者 ID</label>
                        <input type="text" id="sponsorName" class="ios-input" required placeholder="玩家名称">
                    </div>
                    <div class="form-group">
                        <label for="sponsorAmount">注入能量</label>
                        <input type="text" id="sponsorAmount" class="ios-input" required placeholder="例如：100R / 500 Credits">
                    </div>
                    <button type="submit" class="ios-btn-primary" style="height: 48px;">
                        <i class="fas fa-plus"></i> 录入
                    </button>
                </form>
            </div>

            <!-- 列表区域 -->
            <div class="list-container">
                <!-- 表头 -->
                <div class="list-header" id="sponsors-header-row">
                    <div>序</div>
                    <div>缔造者 (ID)</div>
                    <div style="text-align:right;">能量值</div>
                </div>
                
                <!-- 列表内容容器 -->
                <div id="sponsorsContainer">
                    <div class="list-item" style="display: block; text-align: center; padding: 40px; color: var(--ios-text-secondary);">
                        <i class="fas fa-circle-notch fa-spin"></i> 读取档案中...
                    </div>
                </div>
            </div>
            
            <!-- 管理员底部操作 -->
            <div id="adminActions" class="logout-section" style="display: none;">
                <p style="color: var(--ios-text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                    <i class="fas fa-shield-alt"></i> 管理员权限已激活
                </p>
                <button class="logout-btn" onclick="logout()">
                    断开管理链接
                </button>
            </div>

        </div>
    </main>
    
    <!-- 复用主脚本 -->
    <script src="script.js"></script>

    <!-- 页面专属逻辑 -->
    <script>
        // --- 1. 彩蛋逻辑 (保持不变) ---
        document.addEventListener('DOMContentLoaded', function() {
            const title = document.getElementById('sponsors-main-title');
            if (title) {
                let clickCount = 0;
                let clickTimer = null;

                title.addEventListener('click', function() {
                    clickCount++;
                    // 简单的点击反馈动画
                    title.style.transform = 'scale(0.95)';
                    setTimeout(() => title.style.transform = 'scale(1)', 100);

                    if (clickCount === 1) {
                        clickTimer = setTimeout(() => { clickCount = 0; }, 1500);
                    }

                    if (clickCount === 5) {
                        clearTimeout(clickTimer);
                        // 跳转到管理员登录 (假设您有 admin-login.html，或者可以复用 login.html?role=admin)
                        window.location.href = 'admin-login.html'; 
                    }
                });
            }
        });

        // --- 2. 核心业务逻辑 ---
        const adminToken = localStorage.getItem('adminAuthToken');
        const isAdmin = !!adminToken;

        document.addEventListener('DOMContentLoaded', function() {
            if (isAdmin) {
                document.body.classList.add('admin-view');
            }
            renderSponsors();
            toggleAdminFeatures();
            
            const addSponsorForm = document.getElementById('addSponsorForm');
            if (addSponsorForm) {
                addSponsorForm.addEventListener('submit', handleAddSponsor);
            }
        });

        function toggleAdminFeatures() {
            const adminPanel = document.getElementById('adminPanel');
            const adminActions = document.getElementById('adminActions');
            const headerRow = document.getElementById('sponsors-header-row');
            
            if (isAdmin) {
                if (adminPanel) adminPanel.style.display = 'block';
                if (adminActions) adminActions.style.display = 'block';

                // 动态添加表头“操作”列
                if (headerRow && !headerRow.querySelector('.admin-header')) {
                    const adminHeader = document.createElement('div');
                    adminHeader.className = 'admin-header';
                    adminHeader.textContent = '指令';
                    adminHeader.style.textAlign = 'right';
                    headerRow.appendChild(adminHeader);
                }
            }
        }

        async function renderSponsors() {
            const container = document.getElementById('sponsorsContainer');
            if (!container) return;

            try {
                // 这里调用您的后端 API
                const response = await fetch('/api/sponsors');
                if (!response.ok) throw new Error('数据链路中断');
                const sponsors = await response.json();
                
                container.innerHTML = '';
                if (sponsors.length === 0) {
                    container.innerHTML = `
                        <div class="list-item" style="display:block; text-align:center; padding: 40px;">
                            <span style="color:var(--ios-text-secondary)">暂无供奉记录，期待您的加入。</span>
                        </div>`;
                    return;
                }
                
                sponsors.forEach((sponsor, index) => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    // 动画延时进入
                    item.style.animation = `fadeIn 0.5s ease forwards ${index * 0.05}s`;
                    item.style.opacity = '0';
                    
                    let itemHTML = `
                        <div class="item-index">${String(index + 1).padStart(2, '0')}</div>
                        <div class="item-name">
                            <i class="fas fa-medal" style="color: ${index < 3 ? '#fbbf24' : 'var(--ios-text-secondary)'}"></i>
                            ${escapeHTML(sponsor.name)}
                        </div>
                        <div class="item-amount">${escapeHTML(sponsor.amount)}</div>
                    `;
                    
                    if (isAdmin) {
                        itemHTML += `
                            <div class="admin-action" style="text-align:right;">
                                <button class="delete-btn" onclick="removeSponsor(${sponsor.id})">
                                    <i class="fas fa-trash-alt"></i> 移除
                                </button>
                            </div>`;
                    }
                    
                    item.innerHTML = itemHTML;
                    container.appendChild(item);
                });
            } catch (error) {
                container.innerHTML = `
                    <div class="list-item" style="display:block; text-align:center; color:#ef4444;">
                        <i class="fas fa-exclamation-triangle"></i> 数据加载失败: ${error.message}
                    </div>`;
            }
        }
        
        async function handleAddSponsor(e) {
            e.preventDefault();
            if (!isAdmin) return alert('权限拒绝：非管理员操作。');
            
            const sponsorName = document.getElementById('sponsorName').value.trim();
            const sponsorAmount = document.getElementById('sponsorAmount').value.trim();
            if (!sponsorName || !sponsorAmount) return;

            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
            btn.disabled = true;

            try {
                const response = await fetch('/api/admin/sponsors', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` },
                    body: JSON.stringify({ name: sponsorName, amount: sponsorAmount })
                });
                if (!response.ok) throw new Error((await response.json()).error || '录入失败');
                
                // 成功反馈
                document.getElementById('addSponsorForm').reset();
                renderSponsors();
            } catch (error) {
                alert(`错误: ${error.message}`);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function removeSponsor(id) {
            if (!isAdmin) return;
            if (!confirm('警告：您确定要抹除此条供奉记录吗？此操作不可逆。')) return;

            try {
                const response = await fetch(`/api/admin/sponsors/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                if (!response.ok) throw new Error((await response.json()).error || '删除失败');
                renderSponsors();
            } catch (error) {
                alert(`错误: ${error.message}`);
            }
        }

        function logout() {
            localStorage.removeItem('adminAuthToken');
            window.location.reload();
        }
        
        function escapeHTML(str) {
            if (typeof str !== 'string' && str !== null && str !== undefined) {
                str = str.toString();
            }
            if (!str) return '';
            return str.replace(/[&<>"']/g, match => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[match]));
        }
    </script>
    
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</body>
</html>